<script>
    const BIN_ID = '6807514b8561e97a5004df40';
    const API_KEY = '$2a$10$QRCp0YqAthr0rWKw2Pe9yedKLpIZqV2lmH4rpl6v2XDCUYjDgn2qi';

    let currentCardId = null;

    // Check if the user is logged in (based on localStorage)
    function isLoggedIn() {
        return localStorage.getItem('scratch_username') !== null;
    }

    // Open modal to create a new card
    function openCreateCardModal() {
        if (!isLoggedIn()) {
            document.getElementById('login-warning').style.display = 'block';
            return;
        }

        currentCardId = null;
        document.getElementById('modal-title').innerText = 'Create New Card';
        document.getElementById('edit-card-title').value = '';
        document.getElementById('edit-card-text').value = '';
        document.getElementById('editModal').style.display = "block";
    }

    // Open modal to edit existing card
    function openEditModal(cardId) {
        currentCardId = cardId;
        fetchCardFromJsonBin(cardId).then(card => {
            document.getElementById('modal-title').innerText = 'Edit Card';
            document.getElementById('edit-card-title').value = card.title;
            document.getElementById('edit-card-text').value = card.text;
            document.getElementById('editModal').style.display = "block";
        });
    }

    // Close the modal
    document.querySelector('.close').onclick = function() {
        document.getElementById('editModal').style.display = "none";
        document.getElementById('login-warning').style.display = 'none';
    }

    // Close the modal if user clicks outside of it
    window.onclick = function(event) {
        if (event.target === document.getElementById('editModal')) {
            document.getElementById('editModal').style.display = "none";
            document.getElementById('login-warning').style.display = 'none';
        }
    }

    // Save the card after editing or creating
    function saveCard() {
        const title = document.getElementById('edit-card-title').value;
        const text = document.getElementById('edit-card-text').value;

        if (title && text) {
            const cardData = {
                title: title,
                text: text
            };

            if (currentCardId === null) {
                // Create new card
                createCardOnJsonBin(cardData);
            } else {
                // Edit existing card
                updateCardOnJsonBin(currentCardId, cardData);
            }

            // Reload the cards
            loadCards();

            // Close the modal
            document.getElementById('editModal').style.display = "none";
        }
    }

    // Create new card on JSONBin
    function createCardOnJsonBin(cardData) {
        fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'POST',
            headers: {
                'X-Access-Key': API_KEY,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(cardData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Card created successfully:', data);
        })
        .catch(error => console.error('Error creating card:', error));
    }

    // Update card on JSONBin
    function updateCardOnJsonBin(cardId, cardData) {
        fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/cards/${cardId}`, {
            method: 'PATCH',
            headers: {
                'X-Access-Key': API_KEY,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(cardData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Card updated successfully:', data);
        })
        .catch(error => console.error('Error updating card:', error));
    }

    // Delete card from JSONBin
    function deleteCard(cardId) {
        fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/cards/${cardId}`, {
            method: 'DELETE',
            headers: {
                'X-Access-Key': API_KEY
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Card deleted successfully:', data);
            loadCards();
        })
        .catch(error => console.error('Error deleting card:', error));
    }

    // Fetch all cards from JSONBin and load them
    function loadCards() {
        fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/cards`, {
            headers: {
                'X-Access-Key': API_KEY
            }
        })
        .then(response => response.json())
        .then(data => {
            const cards = data.cards || [];
            const container = document.getElementById('cards-container');

            // Clear existing cards
            container.innerHTML = '';

            cards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('card');
                cardElement.innerHTML = `
                    <h3>${card.title}</h3>
                    <p>${card.text}</p>
                    <button onclick="openEditModal(${index})" class="edit-button">Edit</button>
                    <button onclick="deleteCard(${index})" class="delete-button">Delete</button>
                `;
                container.appendChild(cardElement);
            });

            // Disable "Create Card" button if 6 cards already exist
            document.getElementById('create-card-btn').disabled = cards.length >= 6;
        })
        .catch(error => console.error('Error loading cards:', error));
    }

    // Fetch initial card data from JSONBin and load it
    document.addEventListener('DOMContentLoaded', loadCards);
</script>
